<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bienen-KI-Assistent & Protokoll</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4f46e5">
  <link rel="icon" href="icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; padding: 1rem; background: #f0f4f8; }
    /* Animation f√ºr das Laden */
    .animate-spin-fast { animation: spin 0.5s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    /* Icon f√ºr den Bienenstock */
    .colony-icon { font-size: 24px; color: #facc15; /* Gelb wie Honig */ }
    /* Stil f√ºr das Mikrofon */
    #mic-button { transition: transform 0.1s; }
    #mic-button.listening { 
        background-color: #ef4444; /* Rot beim Zuh√∂ren */
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
  </style>
</head>
<body class="flex justify-center min-h-screen p-4 sm:p-8">
  <div id="app-container" class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-6 md:p-10">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold text-yellow-700">Bienen-KI-Assistent & Protokoll</h1>
      <div>
        <button id="install-btn" class="hidden bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded transition duration-200">App installieren</button>
      </div>
    </div>

    <p class="text-sm text-gray-600 mb-4">Ihr sprachgesteuerter Assistent f√ºr alle Fragen rund um die Imkerei.</p>

    <!-- NEU: KI-ASSISTENT SEKTION -->
    <div class="mb-8 p-4 bg-indigo-50 border-2 border-indigo-300 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold text-indigo-700 mb-4">Fragen Sie Ihren Imker-Assistenten üí¨</h2>
        <div id="chat-status" class="text-center mb-4 text-indigo-600 italic">Klicken Sie auf das Mikrofon, um zu sprechen.</div>
        
        <div id="chat-output" class="min-h-[60px] p-3 mb-4 bg-white rounded-lg border border-gray-200 shadow-inner">
            <p class="text-gray-500 italic text-sm">Transkript und Antwort der KI erscheinen hier.</p>
        </div>

        <div class="flex justify-center">
            <button id="mic-button" class="bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-xl focus:outline-none focus:ring-4 focus:ring-indigo-300 transform transition duration-150 ease-in-out">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
                    <path d="M8.25 4.5a3.75 3.75 0 1 1 7.5 0v8.25a3.75 3.75 0 1 1-7.5 0V4.5z" />
                    <path d="M15.75 17.25a6 6 0 0 1-6-6v-1.5a.75.75 0 0 0-1.5 0v1.5a7.5 7.5 0 0 0 15 0v-1.5a.75.75 0 0 0-1.5 0v1.5a6 6 0 0 1-6 6z" />
                </svg>
            </button>
        </div>
    </div>
    <!-- ENDE: KI-ASSISTENT SEKTION -->


    <!-- WETTER-SEKTION -->
    <div class="mb-8 p-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold text-yellow-800 mb-4">Wetterstation einstellen</h2>
      <div class="flex flex-col sm:flex-row gap-3 mb-4">
        <input id="city-input" class="w-full sm:flex-grow p-2 border rounded focus:ring-yellow-500 focus:border-yellow-500" placeholder="Stadt (z.B. Berlin)">
        <button id="change-city-btn" class="w-full sm:w-auto bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded transition duration-200">Wetter laden</button>
      </div>
      <button id="get-location-btn" class="w-full bg-yellow-300 hover:bg-yellow-400 text-yellow-900 py-2 rounded mb-4 transition duration-200">Meinen Standort verwenden</button>
      <div id="bee-warning" class="hidden p-3 mb-4 rounded-lg font-medium text-center shadow-lg bg-red-100 text-red-800 border border-red-300"></div>
      <div id="weather-display" class="min-h-[50px]"><p id="weather-loading" class="italic text-gray-500">Lade Wetterdaten...</p></div>
    </div>
    
    <!-- V√ñLKER-VERWALTUNG -->
    <div class="p-4 border-2 border-indigo-200 rounded-lg shadow-md bg-indigo-50">
      <h2 class="text-xl font-semibold text-indigo-700 mb-4">V√∂lker-Verwaltung</h2>
      
      <!-- Neues Volk hinzuf√ºgen -->
      <div class="flex flex-col gap-3 mb-6 p-4 bg-white rounded-lg border border-indigo-300 shadow-sm">
          <input id="colony-name-input" class="w-full p-2 border rounded focus:ring-indigo-500 focus:border-indigo-500" placeholder="Volksname/ID (z.B. Standort Nord-A)">
          <div class="flex flex-col sm:flex-row gap-3">
              <input id="colony-race-input" class="w-full sm:flex-grow p-2 border rounded focus:ring-indigo-500 focus:border-indigo-500" placeholder="Rasse (z.B. Carnica)">
              <button id="add-colony-btn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition duration-200">Volk hinzuf√ºgen</button>
          </div>
      </div>

      <!-- Liste der V√∂lker -->
      <div id="colony-list" class="space-y-3">
          <p id="empty-colony-message" class="text-gray-500 italic text-center">Noch keine V√∂lker erfasst.</p>
      </div>
    </div>
  </div>

<script>
// --- KONSTANTEN UND VARIABLEN ---
const WEATHER_API_KEY = "86f3db49701e49975bc9a9b7c02257db"; // API-Schl√ºssel eingef√ºgt
const WEATHER_API_URL = "https://api.openweathermap.org/data/2.5/weather";
const DEFAULT_CITY = 'Berlin';
const COLONY_STORAGE_KEY = 'pwa_colonies'; 
const WEATHER_CITY_KEY = 'pwa_last_city';
// NEUER GEMINI API-SCHL√úSSEL
const GEMINI_API_KEY = "AIzaSyCXBbolB6gXHaPV93KTKF4aKc2gVp_7wqk"; 

// --- SERVICE WORKER & PWA INSTALLATION (Unver√§ndert) ---
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(r => console.log('SW registered', r.scope))
      .catch(e => console.error('SW reg failed', e));
  });
}

let deferredPrompt;
const installBtn = document.getElementById('install-btn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.classList.remove('hidden');
});

installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const choice = await deferredPrompt.userChoice;
  console.log('install outcome:', choice.outcome);
  installBtn.classList.add('hidden');
  deferredPrompt = null;
});


// --- V√ñLKER-LOGIK (Unver√§ndert) ---
const colonyNameInput = document.getElementById('colony-name-input');
const colonyRaceInput = document.getElementById('colony-race-input');
const addColonyBtn = document.getElementById('add-colony-btn');
const colonyList = document.getElementById('colony-list');
const emptyColonyMessage = document.getElementById('empty-colony-message');

function getColonies(){ 
    return JSON.parse(localStorage.getItem(COLONY_STORAGE_KEY) || '[]'); 
}

function saveColonies(c){ 
    localStorage.setItem(COLONY_STORAGE_KEY, JSON.stringify(c)); 
    renderColonies(c); 
}

function addColony(){ 
    const name = colonyNameInput.value.trim(); 
    const race = colonyRaceInput.value.trim() || 'Unbekannt'; 
    if(!name) return; 
    
    const colonies = getColonies(); 
    colonies.push({
        id: Date.now(), 
        name: name, 
        race: race,
        lastInspection: 'Noch keine',
        notes: []
    }); 
    saveColonies(colonies); 
    colonyNameInput.value = ''; 
    colonyRaceInput.value = '';
}

function deleteColony(id) {
    // ACHTUNG: confirm() wird in der Sandbox nicht angezeigt. 
    // F√ºr eine echte PWA m√ºsste dies durch ein benutzerdefiniertes Modal ersetzt werden.
    if (confirm(`Sind Sie sicher, dass Sie dieses Volk (ID: ${id}) l√∂schen m√∂chten?`)) {
        saveColonies(getColonies().filter(c => c.id !== id));
    }
}

function renderColonies(colonies){ 
  colonyList.innerHTML = ''; 
  if(colonies.length === 0){ 
    emptyColonyMessage.classList.remove('hidden'); 
    return; 
  } 
  emptyColonyMessage.classList.add('hidden'); 
  
  colonies.forEach(colony => { 
    const div = document.createElement('div'); 
    div.className = 'p-3 bg-white border border-yellow-400 rounded-lg flex justify-between items-center transition duration-200 hover:shadow-lg'; 
    div.innerHTML = `
      <div class="flex items-center flex-grow min-w-0 pr-4">
        <span class="colony-icon mr-3">üêù</span>
        <div>
          <span class="text-lg font-semibold text-gray-900 truncate">${colony.name}</span>
          <p class="text-sm text-gray-500">Rasse: ${colony.race}</p>
          <p class="text-xs text-gray-400">Letzte Pr√ºfung: ${colony.lastInspection}</p>
        </div>
      </div>
      <button data-id="${colony.id}" class="del-colony text-red-500 hover:text-red-700 font-medium transition duration-200 flex-shrink-0 p-1 rounded-full hover:bg-red-100">
        üóëÔ∏è
      </button>
    `;
    colonyList.appendChild(div); 
  }); 
}

addColonyBtn.addEventListener('click', addColony);
colonyNameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        addColony();
    }
});
colonyList.addEventListener('click', (e) => { 
  const target = e.target.closest('button.del-colony');
  if (!target) return;

  const id = Number(target.dataset.id); 
  deleteColony(id);
});


// --- WETTER-LOGIK (Unver√§ndert) ---
const cityInput = document.getElementById('city-input');
const changeCityBtn = document.getElementById('change-city-btn');
const getLocationBtn = document.getElementById('get-location-btn');
const weatherDisplay = document.getElementById('weather-display');
const beeWarning = document.getElementById('bee-warning');

function getBeeAdvice(temp, wind, desc) {
    if (temp < 8) {
        return 'ü•∂ Kalt: Die Bienen bleiben im Stock. Heute ist kein Ausflugwetter.';
    }
    if (temp >= 15 && temp < 25) {
        if (wind < 20 && !desc.includes('regen') && !desc.includes('schauer')) {
            return '‚òÄÔ∏è Optimales Flugwetter! Beste Bedingungen f√ºr die Sammelbienen.';
        }
    }
    if (temp >= 25 && temp <= 30) {
        return 'ü•µ Warm: Gute Tracht zu erwarten. Achten Sie auf ausreichende Bel√ºftung im Stock!';
    }
    if (temp > 30) {
        return 'üî• Sehr hei√ü! Hitzestress droht. Die Bienen ben√∂tigen dringend Wasser und Schatten.';
    }
    if (desc.includes('regen') || desc.includes('schauer')) {
        return 'üåßÔ∏è Regen: Die Bienen bleiben zu Hause. Nutzen Sie die Zeit f√ºr Arbeiten im Haus.';
    }
    if (wind > 25) {
        return 'üí® Achtung, windig! Bei starkem Wind fliegen Bienen ungern. Flugbetrieb ist eingeschr√§nkt.';
    }
    if (temp >= 8) {
        return '‚òÅÔ∏è Okayes Wetter. Kontrollflug ist m√∂glich. Behalten Sie den Himmel im Auge.';
    }
    return 'Wetterdaten sind da, aber keine spezifische Bienen-Empfehlung.';
}

function renderWeather(data) {
  const temp = Math.round(data.main.temp);
  const windSpeed = Math.round(data.wind.speed * 3.6); 
  const description = data.weather[0].description.toLowerCase();
  
  const beeAdvice = getBeeAdvice(temp, windSpeed, description);

  weatherDisplay.innerHTML = `
    <div class="flex items-center space-x-4 mb-3">
      <img src="https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png" alt="${data.weather[0].description}" class="w-16 h-16">
      <div>
        <p class="text-3xl font-bold text-gray-900">${temp}¬∞C</p>
        <p class="text-lg text-gray-700">${data.name}, ${data.sys.country}</p>
        <p class="text-sm text-gray-600">${data.weather[0].description.charAt(0).toUpperCase() + data.weather[0].description.slice(1)} | Wind: ${windSpeed} km/h</p>
      </div>
    </div>
    <div class="p-3 bg-yellow-100 text-yellow-800 rounded-lg border border-yellow-400 font-medium">
        ${beeAdvice}
    </div>
  `;

  if (temp > 30) {
    beeWarning.innerHTML = '<strong>Hitzewarnung:</strong> √úber $30\text{¬∞C}$! Bitte auf die Bienen achten und Wasser bereitstellen. üíßüêù';
    beeWarning.classList.remove('hidden');
  } else {
    beeWarning.classList.add('hidden');
  }
}

function displayError(message) {
  weatherDisplay.innerHTML = `<p class="text-red-600 font-semibold p-2 bg-red-50 rounded">${message}</p>`;
  beeWarning.classList.add('hidden');
}

async function fetchWeather(query) {
  weatherDisplay.innerHTML = '<div class="flex items-center justify-center p-4"><div class="animate-spin-fast rounded-full h-8 w-8 border-t-2 border-b-2 border-yellow-500"></div></div>';

  let url;
  if (query.city) {
    url = `${WEATHER_API_URL}?q=${query.city}&appid=${WEATHER_API_KEY}&units=metric&lang=de`;
    localStorage.setItem(WEATHER_CITY_KEY, query.city);
  } else if (query.lat && query.lon) {
    url = `${WEATHER_API_URL}?lat=${query.lat}&lon=${query.lon}&appid=${WEATHER_API_KEY}&units=metric&lang=de`;
    localStorage.removeItem(WEATHER_CITY_KEY);
  } else {
    fetchWeather({ city: DEFAULT_CITY });
    return; 
  }

  try {
    const response = await fetch(url);
    const data = await response.json();

    if (data.cod === 200) {
      renderWeather(data);
    } else {
      displayError(`Wetterdaten f√ºr ${query.city || 'den Standort'} konnten nicht gefunden werden. (${data.message})`);
    }
  } catch (error) {
    console.error('Fehler beim Abrufen der Wetterdaten:', error);
    displayError('Fehler: Konnte keine Verbindung zum Wetterdienst herstellen.');
  }
}

function handleCityChange() {
  const city = cityInput.value.trim();
  if (city) {
    fetchWeather({ city });
    cityInput.value = '';
  }
}

function handleGeolocation() {
  weatherDisplay.innerHTML = '<div class="flex items-center justify-center p-4"><div class="animate-spin-fast rounded-full h-8 w-8 border-t-2 border-b-2 border-yellow-500"></div></div>';
  
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        fetchWeather({ 
          lat: position.coords.latitude, 
          lon: position.coords.longitude 
        });
      },
      (error) => {
        console.error('Geolocation Fehler:', error);
        displayError('Standort konnte nicht abgerufen werden. Bitte geben Sie manuell eine Stadt ein.');
      },
      {
        timeout: 10000,         
        maximumAge: 60000,      
        enableHighAccuracy: true 
      }
    );
  } else {
    displayError('Geolocation wird von diesem Browser nicht unterst√ºtzt.');
  }
}

changeCityBtn.addEventListener('click', handleCityChange);
cityInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        handleCityChange();
    }
});
getLocationBtn.addEventListener('click', handleGeolocation);


// --- KI-ASSISTENT LOGIK (NEU) ---
const micButton = document.getElementById('mic-button');
const chatStatus = document.getElementById('chat-status');
const chatOutput = document.getElementById('chat-output');

// Check, ob der Browser Speech Recognition unterst√ºtzt
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognitionAvailable = !!SpeechRecognition;

if (!recognitionAvailable) {
    chatStatus.textContent = '‚ùå Sprachbefehle werden von Ihrem Browser nicht unterst√ºtzt.';
    micButton.disabled = true;
}

// Hilfsfunktionen f√ºr TTS
function base64ToArrayBuffer(base64) {
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
}

function pcmToWav(pcm16, sampleRate) {
    const buffer = new ArrayBuffer(44 + pcm16.length * 2);
    const view = new DataView(buffer);
    
    // RIFF identifier 'RIFF'
    view.setUint32(0, 0x52494646, false);
    // file length
    view.setUint32(4, 36 + pcm16.length * 2, true);
    // RIFF type 'WAVE'
    view.setUint32(8, 0x57415645, false);
    // format chunk identifier 'fmt '
    view.setUint32(12, 0x666d7420, false);
    // format chunk length
    view.setUint32(16, 16, true);
    // sample format (1 = PCM)
    view.setUint16(20, 1, true);
    // number of channels
    view.setUint16(22, 1, true);
    // sample rate
    view.setUint32(24, sampleRate, true);
    // byte rate (sample rate * block align)
    view.setUint32(28, sampleRate * 2, true);
    // block align (num channels * bytes per sample)
    view.setUint16(32, 2, true);
    // bits per sample
    view.setUint16(34, 16, true);
    // data chunk identifier 'data'
    view.setUint32(36, 0x64617461, false);
    // data chunk length
    view.setUint32(40, pcm16.length * 2, true);

    let offset = 44;
    for (let i = 0; i < pcm16.length; i++, offset += 2) {
        view.setInt16(offset, pcm16[i], true);
    }
    
    return new Blob([buffer], { type: 'audio/wav' });
}

// Funktion zur Wiedergabe von Audio (TTS)
async function playTtsAudio(text) {
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
    
    const payload = {
        contents: [{
            parts: [{ text: text }]
        }],
        generationConfig: {
            responseModalities: ["AUDIO"],
            speechConfig: {
                voiceConfig: {
                    prebuiltVoiceConfig: { voiceName: "Rasalgethi" } // Eine klare, informative Stimme
                }
            }
        },
        model: "gemini-2.5-flash-preview-tts"
    };

    chatStatus.textContent = 'üó£Ô∏è Antwort wird vorgelesen...';
    
    try {
        let response;
        // Einfacher Retry-Mechanismus (Exponential Backoff)
        for (let i = 0; i < 3; i++) {
            response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (response.ok) break;
            if (i < 2) await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i))); // 1s, 2s, 4s Wartezeit
        }
        if (!response.ok) throw new Error('TTS API Fehler nach mehreren Versuchen.');

        const result = await response.json();
        const part = result?.candidates?.[0]?.content?.parts?.[0];
        const audioData = part?.inlineData?.data;
        const mimeType = part?.inlineData?.mimeType;

        if (audioData && mimeType && mimeType.startsWith("audio/")) {
            const sampleRateMatch = mimeType.match(/rate=(\d+)/);
            const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
            
            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            
            const wavBlob = pcmToWav(pcm16, sampleRate);
            const audioUrl = URL.createObjectURL(wavBlob);
            
            const audio = new Audio(audioUrl);
            audio.play();
            
            audio.onended = () => {
                chatStatus.textContent = '‚úÖ Antwort abgeschlossen. Neue Frage stellen.';
            };
        } else {
            throw new Error('Ung√ºltige oder fehlende Audio-Daten in der TTS-Antwort.');
        }

    } catch (e) {
        console.error("TTS Fehler:", e);
        chatStatus.textContent = `‚ùå TTS Fehler: Konnte Antwort nicht vorlesen. ${e.message}`;
    }
}


// Funktion zur Abfrage der KI (LLM)
async function fetchGeminiResponse(query) {
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
    
    // Den aktuellen Wetterstatus hinzuf√ºgen, um die KI kontextuell zu machen
    const currentAdvice = document.querySelector('#weather-display .p-3.bg-yellow-100')?.textContent.trim() || 'Aktuelle Wetterdaten sind unbekannt.';
    
    const systemPrompt = `Du bist ein freundlicher, erfahrener und praxisorientierter Imker-Experte. Antworte kurz, pr√§gnant und direkt auf die Frage des Nutzers. Beziehe dich bei Entscheidungen (z.B. Kontrollen, F√ºttern) auf die aktuelle Wetterlage. Aktuelle Imker-Wetterlage: "${currentAdvice}".`;
    
    const payload = {
        contents: [{ parts: [{ text: query }] }],
        tools: [{ "google_search": {} }],
        systemInstruction: {
            parts: [{ text: systemPrompt }]
        },
    };

    chatStatus.textContent = 'üß† Denke nach und suche nach Imker-Wissen...';
    
    try {
        let response;
        // Einfacher Retry-Mechanismus
        for (let i = 0; i < 3; i++) {
            response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (response.ok) break;
            if (i < 2) await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i)));
        }
        if (!response.ok) throw new Error('Gemini API Fehler nach mehreren Versuchen.');

        const result = await response.json();
        const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

        if (responseText) {
            chatOutput.innerHTML = `
                <p class="font-bold text-gray-700 mb-2">Ihre Frage: "${query}"</p>
                <p class="text-indigo-800">${responseText}</p>
            `;
            await playTtsAudio(responseText);
        } else {
            throw new Error('KI hat keine Textantwort geliefert.');
        }

    } catch (e) {
        console.error("Gemini Fehler:", e);
        chatStatus.textContent = `‚ùå KI-Fehler: Konnte keine Antwort generieren. ${e.message}`;
    }
}

// Funktion zur Steuerung der Sprachaufnahme
function startSpeechRecognition() {
    if (!recognitionAvailable) return;
    
    const recognition = new SpeechRecognition();
    recognition.lang = 'de-DE';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    micButton.classList.add('listening');
    chatStatus.textContent = 'üî¥ H√∂re zu... Jetzt sprechen...';
    chatOutput.innerHTML = '<p class="text-gray-500 italic text-sm">Transkribiere Ihre Stimme...</p>';

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        chatStatus.textContent = 'üîä Transkription abgeschlossen. Sende an KI...';
        fetchGeminiResponse(transcript);
    };

    recognition.onerror = (event) => {
        console.error('Speech Recognition Error:', event.error);
        chatStatus.textContent = `‚ùå Sprachfehler: ${event.error}. Versuchen Sie es erneut.`;
        micButton.classList.remove('listening');
    };

    recognition.onend = () => {
        micButton.classList.remove('listening');
        if (chatStatus.textContent.includes('H√∂re zu')) {
             chatStatus.textContent = '‚è≥ Aufnahme beendet. Warte auf KI-Antwort...';
        }
    };
    
    recognition.start();
}

micButton.addEventListener('click', startSpeechRecognition);


// --- INITIALISIERUNG ---
document.addEventListener('DOMContentLoaded', () => {
  renderColonies(getColonies());
  const lastCity = localStorage.getItem(WEATHER_CITY_KEY);
  fetchWeather({ city: lastCity || DEFAULT_CITY });
});
</script>
</body>
</html>
